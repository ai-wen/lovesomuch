# [负载均衡](https://dunwu.github.io/blog/pages/98a1c1/)

## 起因
- 垂直扩展： 单机硬件的扩容存在性能瓶颈，无法应对高并发海量数据的挑战
- 水平扩展：
    1、应用集群：应用设计成无状态，多应用节点集群部署
    2、负载均衡：多节点资源的高效使用，网络流量均衡分发的算法(软件或硬件实现)

## 负载均衡的效果：
- 高并发：高效的流量分发，提高吞吐量
- 伸缩性：自由添加或减少服务器数量
- 高可用：监控节点，跳过不可用节点
- 安全防护：额外的安全能力，如黑白名单，防火墙，防DDos等


## 实现方案
### 硬件
    F5 和 A10
    一般支持全局的负载均衡，丰富的算法，性能卓越，单机百万并发，安全功能全面
    成本昂贵，超限动态扩容不足

### 软件
    Nginx、HAProxy、LVS，Apache
    应用广，动态扩展性好，成本低，性能跟硬件平台相关

### 网络模型的四层和七层负载均衡
    - 七层负载均衡：就是可以根据访问用户的 HTTP 请求头、URL 信息将请求转发到特定的主机。
        1、DNS 重定向
        2、HTTP 重定向
        3、反向代理
    -   四层负载均衡：基于 IP 地址和端口进行请求的转发。
        1、修改 IP 地址
        2、修改 MAC 地址
```        
    HAProxy 可以作为 HTTP 和 TCP 负载均衡器。
    Nginx、HAProxy 可以作为四层或七层负载均衡器。
    LVS 可以作为四层负载均衡器。其负载均衡的性能要优于 Nginx。
```

|项目|优点|缺点|
|:-|:-|:-|
|DNS重定向|基于 DNS 查询缓存，按照负载情况返回不同服务器的 IP 地址<br>使用简单:不需要维护均衡服务器<br>提高性能：基于地址解析成用户最近的服务器提高性能（CDN）|可用性差：多级解析,修改后解析时间长<br>自主性差:DNS 负载均衡的控制权在域名商那里，无法对其做更多的改善和扩展；<br>维护性差：也不能反映服务器的当前运行状态；支持的算法少；不能区分服务器的差异|
|HTTP 重定向(缺点明显，较少用)|根据用户的 HTTP 请求计算出一个真实的服务器地址，将该服务器地址写入 HTTP 重定向响应中，返回给浏览器，由浏览器重新进行访问<br>方案简单|额外的转发开销：每次访问需要两次请求服务器，增加了访问的延迟<br>降低搜索排名：使用重定向后，搜索引擎会视为 SEO 作弊<br>如果负载均衡器宕机，就无法访问该站点|
|反向代理（Reverse Proxy）|以 代理服务器 来接受网络请求，然后 将请求转发给内网中的服务器，并将从内网中的服务器上得到的结果返回给网络请求的客户端。<br>多种负载均衡算法：支持多种负载均衡算法，以应对不同的场景需求。<br>可以监控服务器：基于 HTTP 协议，可以监控转发服务器的状态，如：系统负载、响应时间、是否可用、连接数、流量等，从而根据这些数据调整负载均衡的策略。|额外的转发开销：反向代理的转发操作本身是有性能开销的，可能会包括创建连接，等待连接响应，分析响应结果等操作。<br>增加系统复杂度：反向代理常用于做分布式应用的水平扩展，但反向代理服务存在以下问题，为了解决以下问题会给系统整体增加额外的复杂度和运维成本：<br>反向代理服务如果自身宕机，就无法访问站点，所以需要有 高可用 方案，常见的方案有：主备模式（一主一备）、双主模式（互为主备）。<br>反向代理服务自身也存在性能瓶颈，随着需要转发的请求量不断攀升，需要有 可扩展 方案。<br>|
|-|-|-|
|IP 负载均衡|IP 负载均衡是在网络层通过修改请求目的地址进行负载均衡。<br>客户端请求 192.168.137.10，由负载均衡服务器接收到报文。<br>负载均衡服务器根据算法选出一个服务节点 192.168.0.1，然后将报文请求地址改为该节点的 IP。<br>真实服务节点收到请求报文，处理后，返回响应数据到负载均衡服务器。<br>负载均衡服务器将响应数据的源地址改负载均衡服务器地址，返回给客户端。|IP 负载均衡在内核进程完成数据分发，较反向代理负载均衡有更好的处理性能。但是，由于所有请求响应都要经过负载均衡服务器，集群的吞吐量受制于负载均衡服务器的带宽。|
|数据链路层负载均衡|数据链路层负载均衡是指在通信协议的数据链路层修改 mac 地址进行负载均衡。<br>在 Linux 平台上最好的链路层负载均衡开源产品是 LVS (Linux Virtual Server)。<br>LVS 是基于 Linux 内核中 netfilter 框架实现的负载均衡系统。netfilter 是内核态的 Linux 防火墙机制，可以在数据包流经过程中，根据规则设置若干个关卡（hook 函数）来执行相关的操作。<br>LVS 的工作流程大致如下：<br>当用户访问 www.sina.com.cn 时，用户数据通过层层网络，最后通过交换机进入 LVS 服务器网卡，并进入内核网络层。<br>进入 PREROUTING 后经过路由查找，确定访问的目的 VIP 是本机 IP 地址，所以数据包进入到 INPUT 链上<br>IPVS 是工作在 INPUT 链上，会根据访问的 vip+port 判断请求是否 IPVS 服务，如果是则调用注册的 IPVS HOOK 函数，进行 IPVS 相关主流程，强行修改数据包的相关数据，并将数据包发往 POSTROUTING 链上。<br>POSTROUTING 上收到数据包后，根据目标 IP 地址（后端服务器），通过路由选路，将数据包最终发往后端的服务器上。<br>|开源 LVS 版本有 3 种工作模式，每种模式工作原理截然不同，说各种模式都有自己的优缺点，分别适合不同的应用场景，不过最终本质的功能都是能实现均衡的流量调度和良好的扩展性。主要包括三种模式：DR 模式、NAT 模式、Tunnel 模式。|

#### 正向代理与反向代理区别？ 
- 正向代理：发生在 客户端，是由用户主动发起的。翻墙软件就是典型的正向代理，客户端通过主动访问代理服务器，让代理服务器获得需要的外网数据，然后转发回客户端。
- 反向代理：发生在 服务端，用户不知道代理的存在,直接浏览器访问即可。

## 负载均衡算法
- 根据负载均衡算法在候选服务器列表选出一个服务器；
- 将请求数据发送到该服务器上。
### 常见的负载均衡算法的特性及原理：轮询、随机、最小活跃数、源地址哈希、一致性哈希

轮询（Round Robin） 算法的策略是：将请求依次分发到候选服务器。
加权轮询（Weighted Round Robbin） 算法在轮询算法的基础上，增加了权重属性来调节转发服务器的请求数目。性能高、处理速度快的节点应该设置更高的权重，使得分发时优先将请求分发到权重较高的节点上。
随机（Random） 算法 将请求随机分发到候选服务器。
加权随机（Weighted Random） 算法在随机算法的基础上，按照概率调整权重，进行负载分配。
最小活跃数（Least Active） 算法 将请求分发到连接数/请求数最少的候选服务器（目前处理请求最少的服务器）。
哈希（Hash） 算法根据一个 key （可以是唯一 ID、IP 等），通过哈希计算得到一个数值，用该数值在候选服务器列表的进行取模运算，得到的结果便是选中的服务器。
一致性哈希（Consistent Hash） 算法的目标是：相同的请求尽可能落到同一个服务器上。